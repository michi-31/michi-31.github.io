---
title: "9.レイヤ"
date: "2024-10-04"
execute: 
  error: true
  cache: true
format:
  html: 
    slide-level: 2
    toc: true
---

# 目的
ggplot2を用いてグラフィックスの階層化された文法について学習しながら、その基礎について学ぶ。

### 準備
ggplot2パッケージにバンドルされているmpgデータフレームを準備する。
```{r}
library(tidyverse)

# mpgデータフレーム
mpg
```

車種（class）ごとに排気量（displ）と高速道路走行時の燃費（hwy）の関係を可視化する。  

geom()関数は、geomレイヤでローカルに定義されるか、ggplot()レイヤでグローバルに定義されるmapping引数をとる。
```{r}
# classをcolorのエステティック属性にマッピング
ggplot(mpg, aes(x = displ, y = hwy, color = class)) +
 geom_point()

# classをshapeのエステティック属性にマッピング
# plopt2は一度に６つのshapeしか扱えないため、警告が表示される
ggplot(mpg, aes(x = displ, y = hwy, shape = class)) +
 geom_point()

# classをsizeのエステティック属性にマッピング
# 順序付けされてない離散（カテゴリ）変数（class）を順序付けされたエステティック属性（size）にマッピングするため、警告が発生する。
ggplot(mpg, aes(x = displ, y = hwy, size = class)) +
 geom_point()

# classをalphaのエステティック属性にマッピング
ggplot(mpg, aes(x = displ, y = hwy, alpha = class)) +
 geom_point()

# colorをgeom()の引数として視覚的属性を個別に設定する
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point(color = "blue")

# sizeをgeom()の引数として視覚的属性を個別に設定する
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point(size = 1)

# shapeをgeom()の引数として視覚的属性を個別に設定する
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point(shape = 3)
```

# 練習問題
```{r}
# hwhとdispleの散布図　※点はピンクで塗った三角形
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point(shape = 24, fill = "pink")

# 視覚的属性を個別に設定する場合はaes()の外で指定する
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point(color = "blue")

# エステティック属性storke
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point(stroke = 2)

# エステティック属性をaes(color = displ < 5)とした場合
ggplot(mpg, aes(x = displ, y = hwy, color = displ < 5)) +
 geom_point()
```

# 幾何オブジェクト
線の形状は、geom()関数で行う。  
ggplot2は、geom()関数のマッピングをそのレイヤのローカルマッピングとして扱う。
```{r}
# point geom
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point()

# smooth geom
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_smooth()

# 線の種類を設定 shape　※ drv: 駆動方式
ggplot(mpg, aes(x = displ, y = hwy, shape = drv)) +
 geom_smooth()

# 線の種類を設定 linetype
ggplot(mpg, aes(x = displ, y = hwy, linetype = drv)) +
 geom_smooth()

# 線をdrvの値ごとに色付け
# show.legend = FALSEにすることで、回帰線の凡例は表示しない
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_smooth(aes(color = drv), show.legend = FALSE)

# 線の上に元データを重ね、drvの値ごとに色付け
ggplot(mpg, aes(x = displ, y = hwy, color = drv)) +
 geom_point() +
 geom_smooth(aes(linetype = drv))

# レイヤごとに異なるエステティック属性を表示
ggplot(mpg, aes(x = displ, y = hwy)) +
 geom_point(aes(color = class)) +
 geom_smooth()

#  各レイヤに異なるデータを指定
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point() +  # 全データの散布図
  geom_point(
    data = mpg |> filter(class == "2seater"),  # 2seaterクラスのデータ
    color = "red"
  ) +
  geom_point(
    data = mpg |> filter(class == "2seater"),  # 2seaterクラスのデータ
    shape = "circle open", size = 3, color = "red"  # オープンのサークル
  )
```

高速道路走行時の燃費の分布  
ヒストグラムと密度プロットは二峰性で右に裾を引いていることを示すが、箱ひげ図は２つの外れ値があることを示す。
```{r}
# histogram
ggplot(mpg, aes(x = hwy)) +
  geom_histogram(binwidth = 2)

# density
ggplot(mpg, aes(x = hwy)) +
  geom_density()

# boxplot
ggplot(mpg, aes(x = hwy)) +
  geom_boxplot()
```

新しいgeom（geom_density_ridges()）
```{r}
library(ggridges)

ggplot(mpg, aes(x = hwy, y = drv, fill = drv, color = drv)) +
  geom_density_ridges(alpha = 0.5, show.legend = FALSE)
```

# 練習問題
```{r}
# line
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_line()

# boxplot
ggplot(mpg, aes(x = hwy)) +
  geom_boxplot()

# histogram
ggplot(mpg, aes(x = hwy)) +
  geom_histogram(binwidth = 2)

# area
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_area()

# 1
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point() +
  geom_smooth()

# 2
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point() +
  geom_smooth(aes(group = drv))

# 3
ggplot(mpg, aes(x = displ, y = hwy, color = drv)) +
  geom_point() +
  geom_smooth()

# 4
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point(aes(color = drv)) +
  geom_smooth()

# 5
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point(aes(color = drv)) +
  geom_smooth(aes(linetype = drv))

# 6
ggplot(mpg, aes(x = displ, y = hwy, color = drv)) +
  geom_point(aes(fill = drv), shape = 21) +
  geom_point(color = "white", shape = 21, size = 5)
```