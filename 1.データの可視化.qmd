---
title: "1.データの可視化"
date: "2024-09-29"
execute: 
  error: true
  cache: true
format:
  html: 
    slide-level: 2
    toc: true
---
# 目的
Rのデータ可視化パッケージ、ggplot2を用いてデータを可視化します。

# 1.はじめに
### 必要なパッケージをロード
以下の３つのパッケージをロードします。

- tidyverse:  
  ggplot2やdplyrなどのデータ分析や可視化を行うためのパッケージ群の集合体
- palmerpenguins:  
  南極のパーマーランドの３つの島に生息するペンギンの身体の測定値に関するデータ（penguins）を提供するパッケージ
- ggthems:  
  色覚以上に配慮したカラーパレットを提供するパッケージ
```{r}
library(tidyverse)
library(palmerpenguins)
library(ggthemes)
```


# 2.第１ステップ
### データフレームの確認
glimpse()関数を用いることで、データフレームの変数と先頭のいくつかのデータを確認できます。

```{r}
glimpse(penguins)
```

また、View()関数でスクロールやフィルタリングができるインタラクティブなビュアーを表示することができます。
```markdown
View(penguins)
```

### ggplot2の組み立て
ggplot2では、ggplot()関数を用いてプロットを始め、プロットオブジェクトを定義してから「レイヤ」を追加します。  

ggplot()の第１引数はデータセット、第２引数はmapping引数です。  
なお、mapping引数は常にaes()関数で定義され、aes()にて軸の設定などを行います。

mapping引数を定義しないと空のキャンバスが表示されます。
```{r}
ggplot(data = penguins)
```
mapping引数を定義して、aes()関数でｘ軸とｙ軸を指定します。
```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g) # 軸を指定
  )
```
geom_point()関数で点のレイヤをプロットに追加します。

（参考）プロットが使用する幾何オブジェクトの種類

- geom_point(): 散布図
- geom_bar(): 棒グラフ
- geom_line(): 折れ線グラフ
- geom_boxplot(): 箱ひげ図

```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, body_mass_g)
) + 
  geom_point() # 散布図を設定
```
aes()関数内のエステティックマッピングにcolor引数を設定して、ペンギンの種類ごとの色分けを行います。
```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm,
                y = body_mass_g,
                color = species)  # ペンギンの種類ごとの色分けを設定
) +
 geom_point()
```

### ペンギンの種類ごとに直線を引く
散布図にレイヤを追加して体重とフリッパーの関係を示す直線を引きます。
```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm,
                y = body_mass_g, 
                color = species) 
) +
 geom_point() + 
 geom_smooth(method = "lm") # "lm":linear-modelにフィットした線を描画するレイアを追加
```

### ラベルの改善
aes()関数内のエステティックマッピングにshape引数を設定して、ペンギンの種類ごと異なる形を使用します。  

また、labs()関数でプロットラベルにタイトルなどを指定し、scale_color_colorblind()関数でカラーパレットを色覚異常に対応した改善を行います。
```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
) +
 geom_point(mapping = aes(color = species, shape = species)) + # shape引数でペンギンの種類ごと異なる形を使用
 geom_smooth(method = "lm") +
 labs( # プロットラベルにタイトルなどを指定
  title = "Body mass and flipper length",
  subtitle = "Dimentions for Adelie, Chinstrap, and Gentoo Penguins",
  x = "Flipper length(mm)", y = "Body mass(g)",
  colort = "Species", shape = "Species"
 ) + 
 scale_color_colorblind() # カラーパレットを色覚異常に対応
```

# 練習問題
### 1.penguinsの行列数
glimpse()関数を用いることで、344行、８列のデータセットであることがわかります。
```{r}
glimpse(penguins)
```
### 2.bill_depth_mmの意味
??<データセット名>でデータセットの内容を調べることができます。  
bill_depth_mmは、「くちばしの深さ」を意味します。
```markdown
??penguins
```
### 3.bill_depth_mmとbill_length_mmの散布図
散布図より、全体として、くちばしの深さが増加すると長さが減少する関係が見られます。  
また、ペンギンの種類を色分けすることで、両者の関係は種類で異なる傾向がありることがわかります。  
```{r}
ggplot(penguins, aes(x = bill_length_mm,
                     y = bill_depth_mm)) +
  geom_point(aes(color = species, shape = species)) + 
  geom_smooth(method = "lm") + 
  labs(
    title = "Bill depth and Bill length",
    x = "Bill length(mm)", y = "Bill depth(mm)",
    color = "Species", shape = "Species"
  ) + 
  scale_color_colorblind()
```
### 4.speciesとbill_depth_mmの散布図
くちばしの深さの中央値は、種類ごと異なります。  
AdelleとChinstrapに比べてGentooが短い傾向があります。
```{r}
ggplot(penguins, aes(x = species, y = bill_depth_mm)) +
  geom_boxplot() +  
  labs(title = "Species and Bill depth",
       x = "Species", y = "Bill depth(mm)")  
```
### 5.エラー修正
以下のコードがエラーになる原因は、ggplot()でmapping引数が定義されていないためです。
```markdown
ggplot(data = penguins) +  
 geom_point()
```
mapping引数を定義することで散布図を表示することができます。
```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
  ) + 
 geom_point()
```
### 6.geom_point()のna.rm引数
na.rm引数のデフォルト値はFALSEです。欠損値（NA）があるとプロットに反映されず、エラーが発生します。  

TRUEを指定することで欠損値を無視し、プロットを生成することができます。この場合、NAを含む行はプロットから除外されるため、残りのデータのみが描画されます。
```{r}
# NAを含むデータを使った散布図
ggplot(penguins, aes(x = flipper_length_mm,　　　　　　　　　　　 y = body_mass_g)) +
  geom_point(na.rm = TRUE)  # NAを無視してプロット
```
### 7.キャプションの追加
キャプションとは、画像やグラフ、表などのコンテンツに付けられる説明文やタイトルのことです。  
キャプションは、視覚的な要素の内容を補足し、理解を深める役割を果たします。
```{r}
ggplot(penguins, aes(x = flipper_length_mm,
　　　　　　　　　　　 y = body_mass_g)) +
  geom_point(na.rm = TRUE) + 
  labs(
    title = "データはpalmerpenguinsより。"
  )
```

### 8.設例と同じグラフの作成
以下のコードを実行することで、設例と同じグラフを作成することができます。  
method引数に"loess"を指定することで、散布図のデータに対して滑らかな曲線をフィットさせることができます。
```{r}
ggplot(penguins, aes(x = flipper_length_mm,
                     y = body_mass_g)) + 
  geom_point(aes(color = bill_depth_mm)) + 
  geom_smooth(method = "loess") 
```

### 9.コードの出力予測
geom_smooth()関数内でse引数をFALSEにすることで、直線の信頼区間を描画せず、スムージング線のみを表示します。  
これにより、グラフがすっきりとし、視覚的に簡潔になりますが、モデルの不確実性に関する情報は失われます。
```{r}
ggplot(penguins, aes(x = flipper_length_mm,
                     y = body_mass_g,
                     color = island)) + 
  geom_point() + 
  geom_smooth(se = FALSE)
```
### 10.実行結果の説明
エステティックマッピングの定義域が異なるだけで、結果は同じになります。
```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
) + 
  geom_point() + 
  geom_smooth()
```
```{r}
ggplot() +
  geom_point(
    data = penguins,
    mapping = aes(x = flipper_length_mm, y = body_mass_g)
  ) + 
  geom_smooth(
    data = penguins,
    mapping = aes(x = flipper_length_mm, y = body_mass_g)  
    )
```

# 3.ggplot2の呼び出し
ggplot2の最初の２つの引数はdataとmappingですが、これらの表記を省略して簡潔に書くことができます。
```{r}
ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) + 
  geom_point()
```
また、パイプ|>を用いると、以下のように書き直すことができます。
```{r}
penguins |>
 ggplot(aes(x = flipper_length_mm, y = body_mass_g)) + 
 geom_point()
```


# 4.分布の可視化
## 1.カテゴリ変数の表示
geom_bar()関数でカテゴリ変数の分布を棒グラフで表示することができます。  
また、度数に基づいて並び替えるには、変数をファクタに変換します。
```{r}
ggplot(penguins, aes(x = fct_infreq(species))) + 
  geom_bar()
```

### 2.ヒストグラム
geom_histogram()関数でヒストグラムを表示することができます。
なお、binwidth引数でヒストグラムの間隔の幅を設定します。
```{r}
ggplot(penguins, aes(x = body_mass_g)) + 
  geom_histogram(binwidth = 200)
```
geom_density()関数でヒストグラムを平準化した密度プロットを表示することができます。
```{r}
ggplot(penguins, aes(x = body_mass_g)) + 
  geom_density()
```

# 練習問題
## 1.speciesの棒グラフを作成
x = speciesの場合
```{r}
ggplot(penguins, aes(x = fct_infreq(species))) +
  geom_bar()
```
y = speciesの場合
```{r}
ggplot(penguins, aes(y = fct_infreq(species))) +
  geom_bar()
```

## 2.2つの棒グラフの違いを確認
- geom_bar(color = "red"): 棒グラフの縁取りを赤で表示
```{r}
ggplot(penguins, aes(x = fct_infreq(species))) + 
  geom_bar(color = "red")
```
- geom_bar(fill = "red"): 棒グラフの塗りつぶしを赤で表示
```{r}
ggplot(penguins, aes(x = fct_infreq(species))) + 
  geom_bar(fill = "red")
```

### 3.geom_histogram()のbins引数の意味
bins引数は、ヒストグラムの間隔の幅を調整します。

### 4.diamondsデータセットのcarat変数のヒストグラムを作成
binwidthでヒストグラムの幅を0.5に調整します。
```{r}
ggplot(diamonds, aes(x = carat)) + 
  geom_histogram(binwidth = 0.5)
```


# 5.関係の可視化
## 箱ひげ図でデータを可視化
geom_boxplot()で箱ひげ図を作成します。
```{r}
ggplot(penguins, aes(x = species, y = body_mass_g)) + 
  geom_boxplot()
```
geom_densityt()で密度プロットを作成します。
linewidth引数で線の太さを調整します。
```{r}
ggplot(penguins, aes(x = body_mass_g,
                     color = species)) + 
  geom_density(linewidth = 0.75)
```
speciesをcolorとfillでエステティックにマッピングします。
また、alpha引数で色の透過性を追加します。
```{r}
ggplot(penguins, aes(x = body_mass_g,
                     color = species,
                     fill = species)) + 
  geom_density(alpha = 0.5)
```

## 積み上げ図で変数間の関係を可視化
```{r}
ggplot(penguins, aes(x = island, fill = species)) + 
  geom_bar()
```
position = "fill"で相対密度プロットを作成します。  
これにより、島全体のペンギンの数の不平等の影響を排除するため、島全体の種類の分布を比較するのに便利です。
```{r}
ggplot(penguins, aes(x = island, fill = species)) + 
  geom_bar(position = "fill")
```

### 3.プロットをファセットに分割して表示
facet_wrap(~変数名)でプロットを特定の変数のファセット（サブセット）に分割することができます。
```{r}
ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) + 
  geom_point(aes(color = species, shape = species)) + 
  facet_wrap(~island)
```


# 練習問題
### 1.mpgデータフレームの確認
```{r}
glimpse(mpg)
```

### 2.mpgデータフレームのhwyとdisplの散布図
- displ: エンジン排気量
- hwy: 高速道路での燃費

color = ctyで市街地の燃費（cty）に基づき、色を設定します。
```{r}
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point(aes(color = cty)) + 
  geom_smooth(method = "lm")
```
size = ctyで市街地の燃費（cty）に基づき、点のサイズを設定します。
```{r}
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point(aes(size = cty)) + 
  geom_smooth(method = "lm")
```
色と点のサイズの両方を設定します。
```{r}
ggplot(mpg, aes(x = displ, y = hwy)) +
  geom_point(aes(color = cty, size = cty)) + 
  geom_smooth(method = "lm")
```

### 3.３番目の変数をlinewidthにマッピング
linewidthは線の太さを調整するためのもの。geom_point()では、エラーが出ます。

### 4.同じ変数を複数のエステティックにマッピング
同じ変数から出る特徴を視覚的に強調することができます。

### 5.bill_depth_mmとbill_lengthの散布図を作成
くちばしの深さが増加すると長さが減少する傾向があり、全体としては負の相関が見られます。  
ただし、ファセットに分割すると正の相関がみられます。
```{r}
ggplot(penguins, aes(x = bill_depth_mm,
                     y = bill_length_mm,)) +
  geom_point(aes(color = species, shape = species)) +
  geom_smooth(method = "lm") 
```

### 6.凡例の生成
以下のコードでは、ggplot()のaes()関数内で同じ変数（species）をcolorとshapeの両方にマッピングしているため、凡例が2つ表示されます。
```{r}
ggplot(penguins, aes(x = bill_length_mm, 
                     y = bill_depth_mm,
                     color = species,
                     shape = species
  )
) +
 geom_point() +
 labs(color = "Species")
```
geom_point()関数内で指定するように修正します。
```{r}
ggplot(penguins, aes(x = bill_length_mm, 
                     y = bill_depth_mm)
) +
 geom_point(aes(color = species, shape = species)) +
 labs(color = "Species")
```